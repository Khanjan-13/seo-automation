const D=[{tag:"Content Type",icon:"article",desc:"Type of content (Blog, Ad Copy, Email, etc.)"},{tag:"Brand Name",icon:"badge",desc:"Your business or brand name"},{tag:"About Brand",icon:"info",desc:"Short description of the brand"},{tag:"Brand Voice",icon:"record_voice_over",desc:"How the brand should sound"},{tag:"Content Tone",icon:"mood",desc:"Tone/style (Professional, Friendly, Bold, etc.)"},{tag:"USP",icon:"star",desc:"Unique selling points to highlight"},{tag:"Targeted Audience",icon:"group",desc:"Who the content is intended for"},{tag:"Targeted Location",icon:"location_on",desc:"City/Country to target for SEO"},{tag:"Primary Keyword",icon:"vpn_key",desc:"Main SEO keyword to focus on"},{tag:"Secondary Keyword",icon:"key",desc:"Additional keywords to include"},{tag:"Overall Reference",icon:"description",desc:"Reference or sample to follow"},{tag:"H1",icon:"title",desc:"Main Heading"},{tag:"H2",icon:"format_size",desc:"Subheadings"},{tag:"H3",icon:"text_fields",desc:"Additional smaller headings"},{tag:"H4",icon:"title",desc:"Minor subpoints"},{tag:"FAQ",icon:"help",desc:"Frequently asked questions to include"},{tag:"CTA",icon:"campaign",desc:"Call to action statement"},{tag:"Topic",icon:"topic",desc:"Main topic or idea for the content"},{tag:"Description",icon:"notes",desc:"Short description or summary"},{tag:"Words Needed",icon:"straighten",desc:"Required word count"},{tag:"Number of Paragraphs",icon:"list",desc:"How many sections/paragraphs needed"},{tag:"Internal Link",icon:"link",desc:"Links to internal pages for SEO"},{tag:"Reference Link",icon:"link_off",desc:"External links or sources to refer"},{tag:"Content Quality Instructions",icon:"checklist",desc:"Specific quality guidelines"}],o=document.getElementById("editor"),v=document.getElementById("suggestionsBox"),g=document.getElementById("suggestionsList"),b=document.getElementById("promptForm");let f=!1,l=0,x=null;q(D);const H=new URLSearchParams(window.location.search),C=H.get("template");C&&$(C);async function $(e){try{const n=await(await fetch(`/user/templates/api/${e}`)).json();o.innerHTML=n.content,window.history.replaceState({},document.title,window.location.pathname),o.focus()}catch(t){console.error("Error loading template from URL:",t)}}o.addEventListener("keyup",e=>{if(["ArrowUp","ArrowDown","Enter","Escape"].includes(e.key))return;const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0),s=(n.startContainer.textContent||"").substring(0,n.startOffset),a=s.lastIndexOf("/");if(f&&(e.key===" "||e.key==="Escape")){y();return}if(a!==-1&&(a===0||s[a-1]===" "||s[a-1]==="Â ")){const p=s.substring(a+1);x=n.cloneRange(),x.setStart(n.startContainer,a),x.setEnd(n.startContainer,n.startOffset),N(p),R()}else y()});o.addEventListener("keydown",e=>{if(!f){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),b.requestSubmit());return}const t=Array.from(g.querySelectorAll(".menu-item:not(.hidden)"));t.length!==0&&(e.key==="ArrowDown"?(e.preventDefault(),l=(l+1)%t.length,E(t)):e.key==="ArrowUp"?(e.preventDefault(),l=(l-1+t.length)%t.length,E(t)):e.key==="Enter"||e.key==="Tab"?(e.preventDefault(),t[l]&&O(t[l].dataset.tag)):e.key==="Escape"&&(e.preventDefault(),y()))});function E(e){e.forEach((t,n)=>{n===l?(t.classList.add("is-active"),t.scrollIntoView({block:"nearest",behavior:"smooth"})):t.classList.remove("is-active")})}function N(e){const t=e.toLowerCase();let n=0;g.querySelectorAll(".menu-item").forEach(s=>{s.dataset.tag.toLowerCase().includes(t)?(s.classList.remove("hidden"),n++):s.classList.add("hidden")}),n===0?y():(l=0,E(g.querySelectorAll(".menu-item:not(.hidden)")))}function R(){if(f)return;const e=window.getSelection();if(e.rangeCount>0){const t=e.getRangeAt(0).cloneRange();t.collapse(!0);const n=t.getBoundingClientRect(),r=o.getBoundingClientRect(),s=n.bottom-r.top+24,a=n.left-r.left;v.style.top=`${s}px`,v.style.left=`${a}px`}v.classList.remove("hidden"),f=!0,E(g.querySelectorAll(".menu-item:not(.hidden)"))}function y(){v.classList.add("hidden"),f=!1,l=0}function O(e){const t=window.getSelection();t.removeAllRanges(),t.addRange(x),document.execCommand("delete");const n=`&nbsp;<span class="smart-badge" contenteditable="false">${e}:</span>&nbsp;`;document.execCommand("insertHTML",!1,n),y()}function q(e){g.innerHTML=e.map(t=>`
            <div class="menu-item flex items-center gap-3 p-2.5 rounded-lg cursor-pointer transition-colors duration-150 hover:bg-gray-50" 
                 data-tag="${t.tag}"
                 onmousedown="event.preventDefault(); insertBadge('${t.tag}')">
                <div class="icon-box w-8 h-8 flex items-center justify-center rounded-md bg-gray-100 text-gray-500 transition-colors">
                    <span class="material-icons text-[18px]">${t.icon}</span>
                </div>
                <div>
                    <div class="font-semibold text-sm text-gray-800">${t.tag}</div>
                    <div class="text-xs text-gray-400">${t.desc}</div>
                </div>
            </div>
        `).join("")}b.addEventListener("submit",e=>{const t=o.innerText.trim();if(!t||t.length===0)return e.preventDefault(),o.parentElement.classList.add("shake-animation"),setTimeout(()=>{o.parentElement.classList.remove("shake-animation")},500),o.focus(),!1;const n=document.getElementById("aiModel").value,r=["H1","H2","H3","H4","FAQ","CTA"],s=["Topic","Description","Words Needed","Number of Paragraphs","Internal Link","Reference Link","Content Quality Instructions"],a=[];let p=null,d=null;const B=i=>{const m=i.replace(/\u00A0/g," ").trim();m&&d&&(d.content=d.content?d.content+" "+m:m)};o.childNodes.forEach(i=>{if(i.nodeType===Node.TEXT_NODE)B(i.textContent);else if(i.nodeType===Node.ELEMENT_NODE)if(i.classList.contains("smart-badge")){const m=i.innerText.replace(":","").trim(),c={tag:m,content:""};r.includes(m)?(c.children=[],a.push(c),p=c,d=c):s.includes(m)?(p?p.children.push(c):a.push(c),d=c):(p=null,a.push(c),d=c)}else B(i.innerText||i.textContent)});const A={structure:a,model:n},h=document.createElement("input");h.type="hidden",h.name="prompt_payload",h.value=JSON.stringify(A),b.appendChild(h);const S=document.getElementById("loaderOverlay");S&&S.classList.remove("hidden")});const F=document.getElementById("saveTemplateBtn"),M=document.getElementById("templatesBtn"),u=document.getElementById("templatesDropdown"),w=document.getElementById("saveTemplateModal"),_=document.getElementById("closeTemplateModal"),P=document.getElementById("cancelTemplateBtn"),T=document.getElementById("saveTemplateForm"),L=document.getElementById("templatesList");M.addEventListener("click",e=>{e.stopPropagation(),u.classList.toggle("hidden"),u.classList.contains("hidden")||k()});document.addEventListener("click",e=>{!M.contains(e.target)&&!u.contains(e.target)&&u.classList.add("hidden")});F.addEventListener("click",()=>{const e=o.innerText.trim();if(!e||e.length===0){o.parentElement.classList.add("shake-animation"),setTimeout(()=>{o.parentElement.classList.remove("shake-animation")},500),o.focus();return}w.classList.remove("hidden"),document.getElementById("templateName").focus()});_.addEventListener("click",()=>{w.classList.add("hidden"),T.reset()});P.addEventListener("click",()=>{w.classList.add("hidden"),T.reset()});T.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("templateName").value.trim(),n=document.getElementById("templateDescription").value.trim(),r=o.innerHTML;try{(await(await fetch("/user/templates/api",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||document.querySelector('input[name="_token"]').value},body:JSON.stringify({name:t,content:r,description:n||null})})).json()).success?(w.classList.add("hidden"),T.reset(),alert("Template saved successfully!"),u.classList.contains("hidden")||k()):alert("Failed to save template. Please try again.")}catch(s){console.error("Error saving template:",s),alert("An error occurred while saving the template.")}});async function k(){try{const t=await(await fetch("/user/templates/api")).json();t.length===0?L.innerHTML=`
                <div class="text-center py-8 text-gray-400 dark:text-gray-500">
                    <span class="material-icons text-4xl mb-2">folder_open</span>
                    <p class="text-sm">No templates yet</p>
                </div>
            `:L.innerHTML=t.map(n=>`
                <div class="template-item group p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-[#212121] transition-all cursor-pointer border border-transparent hover:border-gray-200 dark:hover:border-gray-700 mb-2" data-template-id="${n.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1" onclick="loadTemplate(${n.id})">
                            <h4 class="font-semibold text-gray-900 dark:text-white text-sm mb-1">${I(n.name)}</h4>
                            ${n.description?`<p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${I(n.description)}</p>`:""}
                            <p class="text-xs text-gray-400 dark:text-gray-500">${j(n.created_at)}</p>
                        </div>
                        <button onclick="deleteTemplate(${n.id}, event)" class="opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-700 p-1">
                            <span class="material-icons text-sm">delete</span>
                        </button>
                    </div>
                </div>
            `).join("")}catch(e){console.error("Error loading templates:",e),L.innerHTML=`
            <div class="text-center py-8 text-red-400">
                <span class="material-icons text-4xl mb-2">error</span>
                <p class="text-sm">Failed to load templates</p>
            </div>
        `}}window.loadTemplate=async function(e){try{const n=await(await fetch(`/user/templates/api/${e}`)).json();o.innerHTML=n.content,u.classList.add("hidden"),o.focus()}catch(t){console.error("Error loading template:",t),alert("Failed to load template.")}};window.deleteTemplate=async function(e,t){if(t.stopPropagation(),!!confirm("Are you sure you want to delete this template?"))try{(await(await fetch(`/user/templates/api/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||document.querySelector('input[name="_token"]').value}})).json()).success?k():alert("Failed to delete template.")}catch(n){console.error("Error deleting template:",n),alert("An error occurred while deleting the template.")}};function I(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function j(e){const t=new Date(e),r=Math.abs(new Date-t),s=Math.floor(r/(1e3*60*60*24));return s===0?"Today":s===1?"Yesterday":s<7?`${s} days ago`:t.toLocaleDateString()}

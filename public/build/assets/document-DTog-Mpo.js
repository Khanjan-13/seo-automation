document.addEventListener("DOMContentLoaded",function(){const q=Quill.import("blots/block/embed");class y extends q{static create(t){let n=super.create();return n.setAttribute("contenteditable","false"),n.innerHTML=`
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
            `,n}}y.blotName="skeleton",y.tagName="div",y.className="skeleton-loader",Quill.register(y);var l=new Quill("#doc-editor",{modules:{toolbar:"#toolbar-container"},theme:"snow",placeholder:"Start writing..."});let M=null;l.on("text-change",function(){L(),clearTimeout(M),M=setTimeout(()=>{C(),A(),$()},500),clearTimeout(O),O=setTimeout(f,100)});const w=new Set(["the","be","to","of","and","a","in","that","have","i","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from","they","we","say","her","she","or","an","will","my","one","all","would","there","their","what","so","up","out","if","about","who","get","which","go","me","when","make","can","like","time","no","just","him","know","take","people","into","year","your","good","some","could","them","see","other","than","then","now","look","only","come","its","over","think","also","back","after","use","two","how","our","work","first","well","way","even","new","want","because","any","these","give","day","most","us","is","was","are","been","has","had","were","said","did","having","may","should","am","being"]);function L(){const e=l.getText(),t=e.trim().length>0?e.trim().split(/\s+/).length:0;document.getElementById("word-count").innerText=t;const n=l.root,r=n.querySelectorAll("h1, h2, h3, h4, h5, h6").length;document.getElementById("heading-count").innerText=r;const s=n.querySelectorAll("p").length;document.getElementById("paragraph-count").innerText=s}function C(){const e=l.getText().trim();if(!e||e.length===0){V();return}const t=e.split(/\s+/),n=t.length,s=e.split(/[.!?]+/).filter(g=>g.trim().length>0).length,a=D(e,n),o=P(e,n,s),i=K(t,n),c=_(n,l.root.querySelectorAll("h1, h2, h3, h4, h5, h6").length,a),u=J(n,l.root.querySelectorAll("h1, h2, h3, h4, h5, h6").length,o,a);W(a),Q(o),U(c),z(i),G(u)}function D(e,t){const n={},s=e.toLowerCase().split(/\s+/).filter(o=>o.length>2);for(let o=0;o<s.length-1;o++){const i=s[o]+" "+s[o+1];(!w.has(s[o])||!w.has(s[o+1]))&&(n[i]=(n[i]||0)+1)}for(let o=0;o<s.length-2;o++){const i=s[o]+" "+s[o+1]+" "+s[o+2];n[i]=(n[i]||0)+1}return Object.entries(n).map(([o,i])=>({keyword:o,count:i,density:(i*o.split(" ").length/t*100).toFixed(2)})).filter(o=>o.count>=2).sort((o,i)=>i.count-o.count).slice(0,20)}function P(e,t,n){if(n===0||t===0)return 0;const r=e.toLowerCase().replace(/[^a-z]/g," ").split(/\s+/).filter(i=>i.length>0).reduce((i,c)=>{const u=c.match(/[aeiouy]+/g);return i+(u?u.length:1)},0),s=t/n,a=r/t,o=206.835-1.015*s-84.6*a;return Math.max(0,Math.min(100,Math.round(o)))}function K(e,t){const n={};return e.forEach(r=>{const s=r.toLowerCase().replace(/[^a-z]/g,"");s.length>3&&!w.has(s)&&(n[s]=(n[s]||0)+1)}),Object.entries(n).map(([r,s])=>({word:r,count:s,percentage:(s/t*100).toFixed(2)})).sort((r,s)=>s.count-r.count).slice(0,10)}function _(e,t,n){const r=[];return e<300?r.push({type:"error",title:"Low word count",message:`Content has only ${e} words. Aim for at least 300 words for better SEO.`}):e<1e3&&r.push({type:"warning",title:"Short content",message:`Content has ${e} words. Consider expanding to 1000+ words for better ranking.`}),t===0?r.push({type:"error",title:"No headings",message:"Add headings (H1-H6) to structure your content for better SEO."}):t<3&&r.push({type:"warning",title:"Few headings",message:`Only ${t} heading(s) found. Add more to improve content structure.`}),n.forEach(s=>{parseFloat(s.density)>5&&r.push({type:"warning",title:"Keyword stuffing",message:`"${s.keyword}" appears too frequently (${s.density}%). Reduce to 1-3% for natural content.`})}),r}function J(e,t,n,r){let s=0;e>=2e3&&e<=2400?s+=30:e>=1e3?s+=20:e>=500&&(s+=10),t>=12&&t<=15?s+=20:t>=5?s+=15:t>=3&&(s+=10),n>=60?s+=30:n>=40?s+=20:n>=20&&(s+=10);const a=r.filter(o=>{const i=parseFloat(o.density);return i>=1&&i<=3});return a.length>=5?s+=20:a.length>=3?s+=15:a.length>=1&&(s+=10),Math.min(100,s)}function W(e){const t=document.getElementById("keywords-list");if(e.length===0){t.innerHTML='<div class="text-center text-sm text-gray-400 py-4">No significant keywords found</div>';return}t.innerHTML=e.map(r=>{const s=parseFloat(r.density);let a="text-gray-600 bg-gray-100 dark:bg-gray-700";return s>=1&&s<=3?a="text-green-600 bg-green-50 dark:bg-green-900/30":s>3&&s<=5?a="text-yellow-600 bg-yellow-50 dark:bg-yellow-900/30":s>5&&(a="text-red-600 bg-red-50 dark:bg-red-900/30"),`
                <div class="flex items-center justify-between group cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded">
                    <span class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1">${r.keyword}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">${r.count}×</span>
                        <span class="text-xs font-medium ${a} px-2 py-0.5 rounded">${r.density}%</span>
                    </div>
                </div>
            `}).join(""),document.getElementById("keyword-search").addEventListener("input",function(r){const s=r.target.value.toLowerCase();t.querySelectorAll("div").forEach(o=>{const i=o.textContent.toLowerCase();o.style.display=i.includes(s)?"flex":"none"})})}function Q(e){document.getElementById("readability-score").textContent=e;let t="",n="";e>=90?(t="Very Easy",n="text-green-600"):e>=80?(t="Easy",n="text-green-600"):e>=70?(t="Fairly Easy",n="text-green-500"):e>=60?(t="Standard",n="text-blue-600"):e>=50?(t="Fairly Difficult",n="text-yellow-600"):e>=30?(t="Difficult",n="text-orange-600"):(t="Very Difficult",n="text-red-600");const r=document.getElementById("readability-label");r.textContent=t,r.className=`text-center text-xs font-medium ${n}`}function U(e){const t=document.getElementById("seo-issues-list"),n=document.getElementById("issues-count");if(n.textContent=e.length,e.length===0){t.innerHTML='<div class="flex items-center gap-2 text-green-600 dark:text-green-400 text-sm p-2 bg-green-50 dark:bg-green-900/20 rounded"><span class="material-icons text-sm">check_circle</span><span>No issues detected</span></div>';return}t.innerHTML=e.map(r=>{const s=r.type==="error"?"error":"warning";return`
                <div class="${r.type==="error"?"text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20":"text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20"} p-3 rounded-lg">
                    <div class="flex items-start gap-2">
                        <span class="material-icons text-sm mt-0.5">${s}</span>
                        <div class="flex-1">
                            <div class="font-medium text-xs mb-1">${r.title}</div>
                            <div class="text-xs opacity-90">${r.message}</div>
                        </div>
                    </div>
                </div>
            `}).join("")}function z(e){const t=document.getElementById("top-words-list");if(e.length===0){t.innerHTML='<div class="text-center text-sm text-gray-400 py-2">No repeated words found</div>';return}t.innerHTML=e.map((n,r)=>`
            <div class="flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-400 w-4">${r+1}</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">${n.word}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">${n.count}×</span>
                    <span class="text-xs text-gray-400">${n.percentage}%</span>
                </div>
            </div>
        `).join("")}function G(e){const t=document.getElementById("seo-score"),n=document.getElementById("score-label"),r=document.getElementById("score-gauge");t.textContent=e,e>=80?n.textContent="Excellent SEO quality":e>=60?n.textContent="Good SEO quality":e>=40?n.textContent="Fair SEO quality":e>0?n.textContent="Needs improvement":n.textContent="Start writing to see your score";const a=e/100*180,o=(a-180)*(Math.PI/180),i=50+40*Math.cos(o),c=50+40*Math.sin(o),u=a>180?1:0;r.setAttribute("d",`M 10 50 A 40 40 0 ${u} 1 ${i} ${c}`),e>=80?r.setAttribute("stroke","#22c55e"):e>=60?r.setAttribute("stroke","#3b82f6"):e>=40?r.setAttribute("stroke","#eab308"):r.setAttribute("stroke","#ef4444")}function V(){document.getElementById("seo-score").textContent="0",document.getElementById("score-label").textContent="Start writing to see your score",document.getElementById("score-gauge").setAttribute("d","M 10 50 A 40 40 0 0 1 10 50"),document.getElementById("keywords-list").innerHTML='<div class="text-center text-sm text-gray-400 py-4">Start writing to see keyword analysis</div>',document.getElementById("readability-score").textContent="0",document.getElementById("readability-label").textContent="No content yet",document.getElementById("readability-label").className="text-center text-xs text-gray-500 dark:text-gray-400",document.getElementById("seo-issues-list").innerHTML='<div class="text-center text-sm text-gray-400 py-2">No issues detected</div>',document.getElementById("issues-count").textContent="0",document.getElementById("top-words-list").innerHTML='<div class="text-center text-sm text-gray-400 py-2">Start writing to see analysis</div>'}const H=document.querySelectorAll(".tab-btn"),X=document.querySelectorAll(".tab-content");H.forEach(e=>{e.addEventListener("click",function(){const t=this.getAttribute("data-tab");H.forEach(n=>{n.classList.remove("text-indigo-600","dark:text-indigo-400","border-b-2","border-indigo-600","dark:border-indigo-400"),n.classList.add("text-gray-500","dark:text-gray-400")}),this.classList.remove("text-gray-500","dark:text-gray-400"),this.classList.add("text-indigo-600","dark:text-indigo-400","border-b-2","border-indigo-600","dark:border-indigo-400"),X.forEach(n=>{n.classList.add("hidden")}),document.getElementById(`tab-content-${t}`).classList.remove("hidden")})});function A(){const e=l.getText().trim();if(!e||e.length===0){re();return}const t=Y(e);te(t);const n=Z(e);ne(n);const r=ee(e);se(r)}function Y(e){const t=[];return[/(\d+(?:,\d{3})*(?:\.\d+)?%)/g,/(\$\d+(?:,\d{3})*(?:\.\d+)?(?:\s*(?:million|billion|trillion|k|M|B))?)/gi,/(\d+(?:,\d{3})*(?:\.\d+)?\s*(?:million|billion|trillion|thousand))/gi,/(\d+(?:,\d{3})*(?:\.\d+)?(?:\s*(?:users|customers|people|items|products|sales)))/gi].forEach(r=>{const s=e.match(r);s&&s.forEach(a=>{const o=e.indexOf(a),i=Math.max(0,o-50),c=Math.min(e.length,o+a.length+50),u=e.substring(i,c).trim();t.find(g=>g.value===a)||t.push({value:a,context:u})})}),t.slice(0,10)}function Z(e){const t=[];return[/\b(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}\b/gi,/\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,/\b\d{4}-\d{2}-\d{2}\b/g,/\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},?\s+\d{4}\b/gi].forEach(r=>{const s=e.match(r);s&&s.forEach(a=>{const o=e.indexOf(a),i=Math.max(0,o-40),c=Math.min(e.length,o+a.length+40),u=e.substring(i,c).trim();t.find(g=>g.value===a)||t.push({value:a,context:u})})}),t.slice(0,10)}function ee(e){const t=[],n=e.split(/[.!?]+/).filter(s=>s.trim().length>20),r=["important","significant","key","essential","critical","major","primary","main","fundamental","crucial","vital","notable","first","largest","biggest","most","best","top"];return n.forEach(s=>{const a=s.toLowerCase(),o=r.some(c=>a.includes(c)),i=/\d/.test(s);(o||i)&&s.trim().length>30&&t.push(s.trim())}),t.slice(0,8)}function te(e){const t=document.getElementById("statistics-list");if(e.length===0){t.innerHTML='<div class="text-center text-sm text-gray-400 py-2">No statistics found</div>';return}t.innerHTML=e.map(n=>`
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                <div class="flex items-center gap-2 mb-1">
                    <span class="material-icons text-blue-600 dark:text-blue-400 text-sm">bar_chart</span>
                    <span class="font-bold text-blue-900 dark:text-blue-100">${n.value}</span>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${n.context}</p>
            </div>
        `).join("")}function ne(e){const t=document.getElementById("dates-list");if(e.length===0){t.innerHTML='<div class="text-center text-sm text-gray-400 py-2">No dates found</div>';return}t.innerHTML=e.map(n=>`
            <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-3">
                <div class="flex items-center gap-2 mb-1">
                    <span class="material-icons text-purple-600 dark:text-purple-400 text-sm">event</span>
                    <span class="font-bold text-purple-900 dark:text-purple-100">${n.value}</span>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${n.context}</p>
            </div>
        `).join("")}function se(e){const t=document.getElementById("facts-list");if(e.length===0){t.innerHTML='<div class="text-center text-sm text-gray-400 py-2">Write content to extract key facts</div>';return}t.innerHTML=e.map((n,r)=>`
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <span class="material-icons text-green-600 dark:text-green-400 text-sm mt-0.5">check_circle</span>
                    <p class="text-xs text-gray-700 dark:text-gray-300 flex-1">${n}</p>
                </div>
            </div>
        `).join("")}function re(){document.getElementById("statistics-list").innerHTML='<div class="text-center text-sm text-gray-400 py-2">No statistics found</div>',document.getElementById("dates-list").innerHTML='<div class="text-center text-sm text-gray-400 py-2">No dates found</div>',document.getElementById("facts-list").innerHTML='<div class="text-center text-sm text-gray-400 py-2">Write content to extract key facts</div>'}function $(){const e=document.getElementById("outline-list"),t=l.root.querySelectorAll("h1, h2, h3, h4, h5, h6");if(t.length===0){e.innerHTML=`
                <div class="text-center text-sm text-gray-400 py-8">
                    <span class="material-icons text-3xl mb-2">list_alt</span>
                    <p>Add headings to create an outline</p>
                </div>
            `;return}e.innerHTML=Array.from(t).map((n,r)=>{const s=parseInt(n.tagName.substring(1)),a=n.textContent.trim(),o=(s-1)*12;let i="article",c="text-gray-700 dark:text-gray-300";return s===1?(i="title",c="text-indigo-600 dark:text-indigo-400"):s===2?(i="subject",c="text-blue-600 dark:text-blue-400"):s===3&&(i="notes",c="text-teal-600 dark:text-teal-400"),`
                <div class="outline-item flex items-start gap-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors group" 
                     style="padding-left: ${o+8}px"
                     data-heading-index="${r}">
                    <span class="material-icons ${c} text-sm mt-0.5">${i}</span>
                    <span class="text-sm ${c} group-hover:text-indigo-600 dark:group-hover:text-indigo-400 flex-1 font-medium">${a}</span>
                </div>
            `}).join(""),e.querySelectorAll(".outline-item").forEach((n,r)=>{n.addEventListener("click",()=>{const s=t[r];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.style.backgroundColor="rgba(99, 102, 241, 0.1)",setTimeout(()=>{s.style.backgroundColor=""},1e3))})})}L(),C(),A(),$();const T=document.getElementById("overlay-container"),N=document.getElementById("regen-modal"),oe=document.getElementById("confirm-regen-btn"),ie=document.getElementById("cancel-regen-btn"),S=document.getElementById("regen-instructions"),ae=document.getElementById("regen-model");let x=null,O=null;function f(){T.innerHTML="";const e=l.root.querySelectorAll("h1, h2, h3, h4, h5, h6");l.root.getBoundingClientRect();const t=T.getBoundingClientRect();e.forEach((n,r)=>{const s=n.getBoundingClientRect(),a=s.top-t.top,o=s.right-t.left+10;if(a<0||a>t.height)return;const i=document.createElement("div");i.className="regenerate-overlay-btn",i.innerHTML='<span class="material-icons text-[14px]">autorenew</span> Regenerate',i.style.top=`${a}px`,i.style.left=`${o}px`,i.onclick=()=>le(n),T.appendChild(i)})}document.getElementById("editor-container").addEventListener("scroll",function(){f()}),window.addEventListener("resize",f),setTimeout(f,500);function le(e){x=e,S.value="",N.classList.remove("hidden"),S.focus()}function F(){N.classList.add("hidden"),x=null}ie.addEventListener("click",F),oe.addEventListener("click",function(){x&&(ce(x),F())});function ce(e){const t=Quill.find(e);if(!t){console.error("Could not find Quill blot for heading");return}const r=l.getIndex(t)+t.length();let s=e.nextElementSibling;for(;s&&!["H1","H2","H3","H4","H5","H6"].includes(s.tagName);)s=s.nextElementSibling;let a;if(s){const m=Quill.find(s);a=l.getIndex(m)}else a=l.getLength();const o=a-r;let i="",c=e.nextElementSibling;for(;c&&c!==s;)i+=c.outerHTML,c=c.nextElementSibling;if(!i.trim()&&o<=1){alert("This section is empty. Please write some content to regenerate.");return}let u="",g=e.previousElementSibling,R=0;for(;g&&R<1e3;)u=g.innerText+`
`+u,R+=g.innerText.length,g=g.previousElementSibling;let k=o;s&&k>0&&(k=k-1),l.deleteText(r,k),l.insertEmbed(r,"skeleton",!0),fetch(window.AppConfig.routes.regenerate,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken},body:JSON.stringify({section_content:i,context:u,model:ae.value,instructions:S.value})}).then(m=>m.json()).then(m=>{l.deleteText(r,1),m.success?(l.clipboard.dangerouslyPasteHTML(r,m.content),b=!0,d.classList.add("ring-2","ring-blue-300"),setTimeout(f,100)):(l.clipboard.dangerouslyPasteHTML(r,i),console.error("Regeneration Error (Server):",m.message),alert("Error regenerating content: "+m.message))}).catch(m=>{l.deleteText(r,1),l.clipboard.dangerouslyPasteHTML(r,i),console.error("Regeneration Error (Network/Client):",m),alert("An error occurred. Check console for details.")})}let b=!1;const d=document.getElementById("save-btn"),de=l.root.innerHTML;l.on("text-change",function(){l.root.innerHTML!==de&&(b=!0,d.classList.add("ring-2","ring-blue-300")),L()}),window.addEventListener("beforeunload",function(e){b&&(e.preventDefault(),e.returnValue="")}),d.addEventListener("click",function(){const e=l.root.innerHTML,t=d.innerHTML;d.innerHTML='<span class="material-icons text-[18px] animate-spin">refresh</span> Saving...',d.disabled=!0,fetch(window.AppConfig.routes.update,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken},body:JSON.stringify({content:e})}).then(n=>n.json()).then(n=>{n.success?(b=!1,d.classList.remove("ring-2","ring-blue-300"),d.innerHTML='<span class="material-icons text-[18px]">check</span> Saved',d.classList.replace("bg-blue-600","bg-green-600"),d.classList.replace("hover:bg-blue-700","hover:bg-green-700"),setTimeout(()=>{d.innerHTML=t,d.classList.replace("bg-green-600","bg-blue-600"),d.classList.replace("hover:bg-green-700","hover:bg-blue-700"),d.disabled=!1},2e3)):(console.error("Save Error (Server):",n.message),alert("Error saving document: "+n.message),d.innerHTML=t,d.disabled=!1)}).catch(n=>{console.error("Save Error (Network/Client):",n),alert("An error occurred while saving."),d.innerHTML=t,d.disabled=!1})});const h=document.getElementById("document-title");let v=h?h.value:"";h&&(h.addEventListener("blur",function(){const e=this.value.trim();e&&e!==v&&ue(e)}),h.addEventListener("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),this.blur())}));function ue(e){window.AppConfig.routes.update.match(/\/document\/(\d+)/)[1],fetch(window.AppConfig.routes.update,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken},body:JSON.stringify({title:e})}).then(t=>t.json()).then(t=>{t.success?(v=e,console.log("Title updated successfully")):(console.error("Title update failed:",t.message),h.value=v)}).catch(t=>{console.error("Title update error:",t),h.value=v})}const ge=document.getElementById("share-btn"),j=document.getElementById("share-modal"),me=document.querySelectorAll("#close-share-modal, #close-share-modal-btn"),E=document.getElementById("share-link-input"),p=document.getElementById("copy-link-btn"),pe=document.getElementById("open-google-docs-btn");let B="",I="";ge.addEventListener("click",function(){j.classList.remove("hidden"),E.value="Generating link...";const e=window.AppConfig.routes.update.match(/\/document\/(\d+)/)[1];fetch(`/user/document/${e}/share`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken}}).then(t=>t.json()).then(t=>{t.success?(B=t.share_url,I=t.google_docs_url,E.value=t.share_url):(E.value="Error generating link",alert("Failed to generate share link: "+(t.message||"Unknown error")))}).catch(t=>{console.error("Share Error:",t),E.value="Error generating link",alert("An error occurred while generating the share link.")})}),me.forEach(e=>{e.addEventListener("click",function(){j.classList.add("hidden")})}),p.addEventListener("click",function(){B&&navigator.clipboard.writeText(B).then(()=>{const e=p.innerHTML;p.innerHTML='<span class="material-icons text-sm">check</span> Copied!',p.classList.replace("bg-indigo-600","bg-green-600"),p.classList.replace("hover:bg-indigo-500","hover:bg-green-500"),setTimeout(()=>{p.innerHTML=e,p.classList.replace("bg-green-600","bg-indigo-600"),p.classList.replace("hover:bg-green-500","hover:bg-indigo-500")},2e3)}).catch(e=>{alert("Failed to copy link to clipboard")})}),pe.addEventListener("click",function(){I&&window.open(I,"_blank")})});

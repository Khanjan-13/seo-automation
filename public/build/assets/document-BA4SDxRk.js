document.addEventListener("DOMContentLoaded",function(){const H=Quill.import("blots/block/embed");class m extends H{static create(r){let n=super.create();return n.setAttribute("contenteditable","false"),n.innerHTML=`
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
            `,n}}m.blotName="skeleton",m.tagName="div",m.className="skeleton-loader",Quill.register(m);var e=new Quill("#doc-editor",{modules:{toolbar:"#toolbar-container"},theme:"snow",placeholder:"Start writing..."});e.on("text-change",function(){v(),clearTimeout(y),y=setTimeout(d,100)});function v(){const o=e.getText(),r=o.trim().length>0?o.trim().split(/\s+/).length:0;document.getElementById("word-count").innerText=r;const n=e.root,s=n.querySelectorAll("h1, h2, h3, h4, h5, h6").length;document.getElementById("heading-count").innerText=s;const i=n.querySelectorAll("p").length;document.getElementById("paragraph-count").innerText=i}v();const T=document.getElementById("overlay-container"),E=document.getElementById("regen-modal"),B=document.getElementById("confirm-regen-btn"),C=document.getElementById("cancel-regen-btn"),x=document.getElementById("regen-instructions"),k=document.getElementById("regen-model");let h=null,y=null;function d(){T.innerHTML="";const o=e.root.querySelectorAll("h1, h2, h3, h4, h5, h6");e.root.getBoundingClientRect();const r=T.getBoundingClientRect();o.forEach((n,s)=>{const i=n.getBoundingClientRect(),a=i.top-r.top,f=i.right-r.left+10;if(a<0||a>r.height)return;const l=document.createElement("div");l.className="regenerate-overlay-btn",l.innerHTML='<span class="material-icons text-[14px]">autorenew</span> Regenerate',l.style.top=`${a}px`,l.style.left=`${f}px`,l.onclick=()=>M(n),T.appendChild(l)})}document.getElementById("editor-container").addEventListener("scroll",function(){d()}),window.addEventListener("resize",d),setTimeout(d,500);function M(o){h=o,x.value="",E.classList.remove("hidden"),x.focus()}function S(){E.classList.add("hidden"),h=null}C.addEventListener("click",S),B.addEventListener("click",function(){h&&(I(h),S())});function I(o){const r=Quill.find(o);if(!r){console.error("Could not find Quill blot for heading");return}const s=e.getIndex(r)+r.length();let i=o.nextElementSibling;for(;i&&!["H1","H2","H3","H4","H5","H6"].includes(i.tagName);)i=i.nextElementSibling;let a;if(i){const c=Quill.find(i);a=e.getIndex(c)}else a=e.getLength();const f=a-s;let l="",u=o.nextElementSibling;for(;u&&u!==i;)l+=u.outerHTML,u=u.nextElementSibling;if(!l.trim()&&f<=1){alert("This section is empty. Please write some content to regenerate.");return}let L="",g=o.previousElementSibling,w=0;for(;g&&w<1e3;)L=g.innerText+`
`+L,w+=g.innerText.length,g=g.previousElementSibling;let b=f;i&&b>0&&(b=b-1),e.deleteText(s,b),e.insertEmbed(s,"skeleton",!0),fetch(window.AppConfig.routes.regenerate,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken},body:JSON.stringify({section_content:l,context:L,model:k.value,instructions:x.value})}).then(c=>c.json()).then(c=>{e.deleteText(s,1),c.success?(e.clipboard.dangerouslyPasteHTML(s,c.content),p=!0,t.classList.add("ring-2","ring-blue-300"),setTimeout(d,100)):(e.clipboard.dangerouslyPasteHTML(s,l),console.error("Regeneration Error (Server):",c.message),alert("Error regenerating content: "+c.message))}).catch(c=>{e.deleteText(s,1),e.clipboard.dangerouslyPasteHTML(s,l),console.error("Regeneration Error (Network/Client):",c),alert("An error occurred. Check console for details.")})}let p=!1;const t=document.getElementById("save-btn"),R=e.root.innerHTML;e.on("text-change",function(){e.root.innerHTML!==R&&(p=!0,t.classList.add("ring-2","ring-blue-300")),v()}),window.addEventListener("beforeunload",function(o){p&&(o.preventDefault(),o.returnValue="")}),t.addEventListener("click",function(){const o=e.root.innerHTML,r=t.innerHTML;t.innerHTML='<span class="material-icons text-[18px] animate-spin">refresh</span> Saving...',t.disabled=!0,fetch(window.AppConfig.routes.update,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":window.AppConfig.csrfToken},body:JSON.stringify({content:o})}).then(n=>n.json()).then(n=>{n.success?(p=!1,t.classList.remove("ring-2","ring-blue-300"),t.innerHTML='<span class="material-icons text-[18px]">check</span> Saved',t.classList.replace("bg-blue-600","bg-green-600"),t.classList.replace("hover:bg-blue-700","hover:bg-green-700"),setTimeout(()=>{t.innerHTML=r,t.classList.replace("bg-green-600","bg-blue-600"),t.classList.replace("hover:bg-green-700","hover:bg-blue-700"),t.disabled=!1},2e3)):(console.error("Save Error (Server):",n.message),alert("Error saving document: "+n.message),t.innerHTML=r,t.disabled=!1)}).catch(n=>{console.error("Save Error (Network/Client):",n),alert("An error occurred while saving."),t.innerHTML=r,t.disabled=!1})})});
